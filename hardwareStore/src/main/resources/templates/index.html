<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head('Dashboard')}"></head>

<body class="sb-nav-fixed">
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div id="layoutSidenav">
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>

    <div id="layoutSidenav_content">
        <main>
            <div class="container-fluid px-4">
                <h1 class="mt-4 text-primary fw-bold">Dashboard</h1>
                <ol class="breadcrumb mb-4 bg-light p-2 rounded shadow-sm">
                    <li class="breadcrumb-item active">Resumen General</li>
                </ol>

                <!-- Cards de Resumen -->
                <div class="row g-4">
                    <!-- Ventas del Día -->
                    <div class="col-xl-4 col-md-6">
                        <div class="card shadow hover-card border-0">
                            <div class="card-body d-flex align-items-center justify-content-between">
                                <div>
                                    <div class="fs-6 text-muted">Ventas del Día</div>
                                    <div class="fs-3 fw-bold text-primary" th:text="'$' + ${#numbers.formatInteger(dailySales ?: 0, 0, 'POINT')}"></div>
                                </div>
                                <i class="fas fa-dollar-sign fa-2x text-primary"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Ventas de la Semana -->
                    <div class="col-xl-4 col-md-6">
                        <div class="card shadow hover-card border-0">
                            <div class="card-body d-flex align-items-center justify-content-between">
                                <div>
                                    <div class="fs-6 text-muted">Ventas de la Semana</div>
                                    <div class="fs-3 fw-bold text-warning" th:text="'$' + ${#numbers.formatInteger(weeklySales ?: 0, 0, 'POINT')}"></div>
                                </div>
                                <i class="fas fa-calendar-week fa-2x text-warning"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Ventas del Mes -->
                    <div class="col-xl-4 col-md-6">
                        <div class="card shadow hover-card border-0">
                            <div class="card-body d-flex align-items-center justify-content-between">
                                <div>
                                    <div class="fs-6 text-muted">Ventas del Mes</div>
                                    <div class="fs-3 fw-bold text-success" th:text="'$' + ${#numbers.formatInteger(monthlySales ?: 0, 0, 'POINT')}"></div>
                                </div>
                                <i class="fas fa-chart-line fa-2x text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="row mt-4">
                    <div class="col-xl-8">
                        <div class="card shadow border-0">
                            <div class="card-header bg-primary text-white"><i class="fas fa-chart-area me-1"></i>Ventas de los Últimos 30 Días</div>
                            <div class="card-body">
                                <canvas id="salesChart" width="100%" height="40"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-4">
                        <div class="card shadow border-0">
                            <div class="card-header bg-success text-white"><i class="fas fa-chart-pie me-1"></i>Top 5 Productos Vendidos</div>
                            <div class="card-body">
                                <canvas id="topProductsChart" width="100%" height="40"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tablas de Datos -->
                <div class="row mt-4">
                    <div class="col-lg-6">
                        <div class="card shadow border-0">
                            <div class="card-header bg-info text-white"><i class="fas fa-users me-1"></i>Top 5 Clientes Frecuentes</div>
                            <div class="card-body">
                                <div th:if="${!#lists.isEmpty(topCustomers)}">
                                    <ol class="list-group list-group-flush">
                                        <li th:each="customer : ${topCustomers}" class="list-group-item d-flex justify-content-between align-items-center hover-list">
                                            <span class="fw-bold" th:text="${customer.get('clientName')}"></span>
                                            <span class="badge bg-primary" th:text="'$' + ${#numbers.formatInteger(customer.get('total'), 0, 'POINT')}"></span>
                                        </li>
                                    </ol>
                                </div>
                                <div th:if="${#lists.isEmpty(topCustomers)}" class="text-center text-muted">
                                    No hay datos de clientes.
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card shadow border-0">
                            <div class="card-header bg-danger text-white"><i class="fas fa-triangle-exclamation me-1"></i>Productos con Stock Bajo</div>
                            <div class="card-body">
                                <div th:if="${!#lists.isEmpty(lowStockProducts)}">
                                    <ul class="list-group list-group-flush">
                                        <li th:each="product : ${lowStockProducts}" class="list-group-item d-flex justify-content-between align-items-center hover-list">
                                            <span class="fw-bold" th:text="${product.name}"></span>
                                            <span class="badge bg-danger" th:text="'Stock: ' + ${product.stock}"></span>
                                        </li>
                                    </ul>
                                </div>
                                <div th:if="${#lists.isEmpty(lowStockProducts)}" class="text-center text-muted">
                                    No hay productos con stock bajo.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer th:replace="~{fragments/footer :: footer}"></footer>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/scripts.js}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<!-- Estilos Personalizados -->
<style>
    /* Efecto Hover para tarjetas */
    .hover-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .hover-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    /* Efecto Hover para listas */
    .hover-list {
        transition: background-color 0.2s ease, transform 0.2s ease;
    }
    .hover-list:hover {
        background-color: #f8f9fa;
        transform: scale(1.01);
    }

    /* Mejora visual para gráficos */
    canvas {
        border-radius: 8px;
        overflow: hidden;
    }

    /* Texto más claro en tarjetas */
    .card-body .fs-3 {
        font-weight: 600;
    }

    /* Ajuste de altura máxima para gráficos */
    .card-body > canvas {
        max-height: 300px;
    }
</style>

<script th:inline="javascript">
    /*<![CDATA[*/
    // Data from model
    var monthlySalesData = /*[[${monthlySalesData}]]*/ [];
    var topProductsData = /*[[${topProducts}]]*/ [];

    // Process sales data for chart
    var salesLabels = monthlySalesData.map(function(d) { return d.saleDate; });
    var salesValues = monthlySalesData.map(function(d) { return d.total; });

    // Sales Chart (Línea)
    var ctxSales = document.getElementById('salesChart').getContext('2d');
    var salesChart = new Chart(ctxSales, {
        type: 'line',
        data: {
            labels: salesLabels,
            datasets: [{
                label: 'Ventas ($)',
                data: salesValues,
                backgroundColor: 'rgba(0, 123, 255, 0.2)',
                borderColor: 'rgba(0, 123, 255, 1)',
                borderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
                fill: true
            }]
        },
        options: {
            plugins: {
                legend: { display: false },
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    formatter: (value) => '$' + value,
                    color: '#fff'
                }
            },
            scales: {
                x: { grid: { display: false } },
                y: { beginAtZero: true }
            }
        }
    });

    // Top Products Chart (Pastel)
    var ctxTopProducts = document.getElementById('topProductsChart').getContext('2d');
    var topProductsChart = new Chart(ctxTopProducts, {
        type: 'pie',
        data: {
            labels: topProductsData.map(p => p.name),
            datasets: [{
                label: 'Cantidad Vendida',
                data: topProductsData.map(p => p.quantity),
                backgroundColor: [
                    'rgba(0, 123, 255, 0.8)',
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(40, 167, 69, 0.8)',
                    'rgba(220, 53, 69, 0.8)',
                    'rgba(111, 66, 193, 0.8)'
                ],
                hoverOffset: 4
            }]
        },
        options: {
            plugins: {
                legend: { position: 'right' },
                datalabels: {
                    formatter: (value, ctx) => ctx.chart.data.labels[ctx.dataIndex] + ': ' + value,
                    color: '#fff'
                }
            }
        }
    });
    /*]]>*/
</script>

</body>
</html>