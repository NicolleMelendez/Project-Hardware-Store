<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head('Dashboard')}"></head>

<body class="sb-nav-fixed">
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div id="layoutSidenav">
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>

    <div id="layoutSidenav_content">
        <main>
            <div class="container-fluid px-4">
                <h1 class="mt-4">Dashboard</h1>
                <ol class="breadcrumb mb-4">
                    <li class="breadcrumb-item active">Resumen General</li>
                </ol>

                <!-- Cards de Resumen -->
                <div class="row">
                    <div class="col-xl-4 col-md-6">
                        <div class="card bg-primary text-white mb-4">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fs-6">Ventas del Día</div>
                                        <div class="fs-3 fw-bold" th:text="'$' + ${#numbers.formatInteger(dailySales ?: 0, 0, 'POINT')}"></div>
                                    </div>
                                    <i class="fas fa-dollar-sign fa-2x text-white-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-4 col-md-6">
                        <div class="card bg-warning text-dark mb-4">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fs-6">Ventas de la Semana</div>
                                        <div class="fs-3 fw-bold" th:text="'$' + ${#numbers.formatInteger(weeklySales ?: 0, 0, 'POINT')}"></div>
                                    </div>
                                    <i class="fas fa-calendar-week fa-2x text-dark-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-4 col-md-6">
                        <div class="card bg-success text-white mb-4">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fs-6">Ventas del Mes</div>
                                        <div class="fs-3 fw-bold" th:text="'$' + ${#numbers.formatInteger(monthlySales ?: 0, 0, 'POINT')}"></div>
                                    </div>
                                    <i class="fas fa-chart-line fa-2x text-white-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="row">
                    <div class="col-xl-8">
                        <div class="card mb-4">
                            <div class="card-header"><i class="fas fa-chart-area me-1"></i>Ventas de los Últimos 30 Días</div>
                            <div class="card-body"><canvas id="salesChart" width="100%" height="40"></canvas></div>
                        </div>
                    </div>
                    <div class="col-xl-4">
                        <div class="card mb-4">
                            <div class="card-header"><i class="fas fa-chart-pie me-1"></i>Top 5 Productos Vendidos</div>
                            <div class="card-body"><canvas id="topProductsChart" width="100%" height="40"></canvas></div>
                        </div>
                    </div>
                </div>

                <!-- Tablas de Datos -->
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card mb-4">
                            <div class="card-header"><i class="fas fa-users me-1"></i>Top 5 Clientes Frecuentes</div>
                            <div class="card-body">
                                <div th:if="${!#lists.isEmpty(topCustomers)}">
                                    <ol class="list-group list-group-flush">
                                        <li th:each="customer : ${topCustomers}" class="list-group-item d-flex justify-content-between align-items-center">
                                            <span th:text="${customer.get('clientName')}"></span>
                                            <span class="badge bg-primary" th:text="'$' + ${#numbers.formatInteger(customer.get('total'), 0, 'POINT')}"></span>
                                        </li>
                                    </ol>
                                </div>
                                <div th:if="${#lists.isEmpty(topCustomers)}" class="text-center text-muted">
                                    No hay datos de clientes.
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card mb-4">
                            <div class="card-header"><i class="fas fa-triangle-exclamation me-1"></i>Productos con Stock Bajo</div>
                            <div class="card-body">
                                <div th:if="${!#lists.isEmpty(lowStockProducts)}">
                                    <ul class="list-group list-group-flush">
                                        <li th:each="product : ${lowStockProducts}" class="list-group-item d-flex justify-content-between align-items-center">
                                            <span th:text="${product.name}"></span>
                                            <span class="badge bg-danger" th:text="'Stock: ' + ${product.stock}"></span>
                                        </li>
                                    </ul>
                                </div>
                                <div th:if="${#lists.isEmpty(lowStockProducts)}" class="text-center text-muted">
                                    No hay productos con stock bajo.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer th:replace="~{fragments/footer :: footer}"></footer>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/scripts.js}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js" crossorigin="anonymous"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    // Data from model
    var monthlySalesData = /*[[${monthlySalesData}]]*/ [];
    var topProductsData = /*[[${topProducts}]]*/ [];

    // Process sales data for chart
    var salesLabels = monthlySalesData.map(function(d) { return d.saleDate; });
    var salesValues = monthlySalesData.map(function(d) { return d.total; });

    // Sales Chart
    var ctxSales = document.getElementById('salesChart').getContext('2d');
    var salesChart = new Chart(ctxSales, {
        type: 'line',
        data: {
            labels: salesLabels,
            datasets: [{
                label: 'Ventas ($)',
                data: salesValues,
                backgroundColor: 'rgba(0, 123, 255, 0.2)',
                borderColor: 'rgba(0, 123, 255, 1)',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Process top products data for chart
    var topProductsLabels = topProductsData.map(function(p) { return p.name; });
    var topProductsValues = topProductsData.map(function(p) { return p.quantity; });

    // Top Products Chart
    var ctxTopProducts = document.getElementById('topProductsChart').getContext('2d');
    var topProductsChart = new Chart(ctxTopProducts, {
        type: 'pie',
        data: {
            labels: topProductsLabels,
            datasets: [{
                label: 'Cantidad Vendida',
                data: topProductsValues,
                backgroundColor: [
                    'rgba(0, 123, 255, 0.8)',
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(40, 167, 69, 0.8)',
                    'rgba(220, 53, 69, 0.8)',
                    'rgba(111, 66, 193, 0.8)'
                ]
            }]
        }
    });
    /*]]>*/
</script>

</body>
</html>